val logName = "dehumidifier"

var Timer timer = null

val DEHUMIDIFIER_ON_TIME_MIN = 10

rule "Dehumidifier Startup"
when
  System started
then
  mystrom_switch.sendCommand(OFF)
end

rule "Dehumidifier with Timeout"
when
  Item trigger_dehumidifier changed or
  Time cron "0 0/1 * * * ?"   // every minute
then
  if (trigger_dehumidifier.state == ON)
  {
    mystrom_switch.sendCommand(ON)
    //logInfo(logName, "Dehumidifier ON")

    if (timer !== null) {
      //logInfo(logName, "Timer rescheduled")
      timer.reschedule(now.plusMinutes(DEHUMIDIFIER_ON_TIME_MIN))
    } else {
      timer = createTimer(now.plusMinutes(DEHUMIDIFIER_ON_TIME_MIN), [ |
        mystrom_switch.sendCommand(OFF)
        //logInfo(logName, "Timer expiration")
        timer = null
      ])
      //logInfo(logName, "Timer created")
    }
  }
end
