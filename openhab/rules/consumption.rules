val logName = "consumption"

var Number moving_average_power_inverter
var Number moving_average_power_grid
var Number moving_average_power_consumption

val FORGETTING_FACTOR = 4

rule "Electricity Consumption Startup"
when
  System started
then
  filtered_power_inverter.sendCommand(0)
  filtered_power_grid.sendCommand(0)
  filtered_power_consumption.sendCommand(0)
  moving_average_power_inverter = 0
  moving_average_power_grid = 0
  moving_average_power_consumption = 0
end

rule "Total Electricity Consumption"
when
  Time cron "0/15 * * * * ?"                // every 15 seconds
then
  // val Number Power_Inverter = Current_Power_Meter1_Inverter + Current_Power_Meter2_Inverter + Current_Power_Meter3_Inverter
  val Number Power_Inverter = TestInverter.state
  // val Number Power_Power_Grid = Current_Power_Meter1_Power_Grid + Current_Power_Meter2_Power_Grid + Current_Power_Meter3_Power_Grid
  val Number Power_Power_Grid = TestGrid.state
  val Number current_power_consumption = Power_Inverter + Power_Power_Grid

  // Filter Power Inverter
  moving_average_power_inverter = moving_average_power_inverter - ( moving_average_power_inverter / FORGETTING_FACTOR ) + Power_Inverter
  filtered_power_inverter.sendCommand( moving_average_power_inverter / FORGETTING_FACTOR )

  // Filter Electricity Grid
  moving_average_power_grid = moving_average_power_grid - ( moving_average_power_grid / FORGETTING_FACTOR ) + Power_Power_Grid
  filtered_power_grid.sendCommand( moving_average_power_grid / FORGETTING_FACTOR )

  // Filter Electricity Consumption
  moving_average_power_consumption = moving_average_power_inverter + moving_average_power_grid
  filtered_power_consumption.sendCommand( moving_average_power_consumption / FORGETTING_FACTOR )

  // logInfo(logName, "moving_average_power_grid: " + moving_average_power_grid)
  // logInfo(logName, "moving_average_power_inverter: " + moving_average_power_inverter)
  // logInfo(logName, "moving_average_power_consumption: " + moving_average_power_consumption)

  // logInfo(logName, "filtered_power_inverter: " + filtered_power_inverter.state.toString)
  // logInfo(logName, "filtered_power_grid: " + filtered_power_grid.state.toString)
  // logInfo(logName, "filtered_power_consumption: " + filtered_power_consumption.state.toString)
end
